<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HISTORICO ALFARNATE</title>
  <style>
:root { --bg:#0b0f14; --card:#121821; --ink:#e8eef7; --muted:#9fb0c6; --accent:#6ec1ff; --line:#223042; }
* { box-sizing: border-box; }
body { margin:0; font-family: system-ui, sans-serif; background:var(--bg); color:var(--ink); }
header { padding:20px; border-bottom:1px solid var(--line); text-align:center; }
.wrap { max-width:1100px; margin:0 auto; padding:20px; }
.card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; }
.form { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; margin-bottom:12px; }
label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
input, button { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0d131b; color:var(--ink); }
button { cursor:pointer; background:#0f1823; border-color:#1e2b3c; }
button.primary { background:#102033; border-color:#28507a; }
.row { display:flex; gap:10px; }
.row > * { flex:1; }
.kpigrid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; margin-top:12px; }
.kpi { background:#0d131b; border:1px dashed var(--line); padding:12px; border-radius:10px; text-align:center; }
.kpi b { display:block; font-size:12px; color: var(--muted); }
.kpi span { font-size:22px; display:block; margin-top:4px; }
.table-shell { margin-top:16px; background:#0d131b; border-radius:12px; overflow:auto; }
table { width:100%; border-collapse:collapse; }
thead th { position:sticky; top:0; background:#101722; }
th, td { border-bottom:1px solid #172333; text-align:left; padding:8px 10px; font-size:13px; }
tr:hover td { background:#0f1621; }

/* === Sticky header + first column === */
.table-shell { max-height: 80vh; overflow: auto; border: 1px solid #1f2937; border-radius: 10px; }
#dataTable { border-collapse: separate; border-spacing: 0; width: 100%; }
#dataTable thead th { position: sticky; top: 0; z-index: 2; background: #101722; }
#dataTable th, #dataTable td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.06); }
#dataTable tbody tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
#dataTable thead th:first-child, #dataTable tbody td:first-child { position: sticky; left: 0; background: #0b0f14; z-index: 1; box-shadow: 1px 0 0 rgba(255,255,255,0.06); }

</style>
</head>
<body>
  <header><h1>HISTORICO ALFARNATE</h1></header>
  <main class="wrap">
    <div class="card">
      <div class="form">
        <div>
          <label for="date">Fecha desde (YYYY-MM-DD)</label>
          <input id="date" type="date"/>
        </div>
        
        <div>
          <label>&nbsp;</label>
          <div class="row">
            <button class="primary" id="loadBtn">Cargar datos</button>
            <button id="csvBtn" onclick="window.__alfarnate && window.__alfarnate.toCSV()">Exportar CSV</button>
            <button id="xlsxBtn" onclick="window.__alfarnate && window.__alfarnate.toXLSX()">Exportar Excel</button>
          </div>
        </div>
        <div>
          <label>&nbsp;</label>
          <div id="status" class="status">Listo</div>
        </div>
        <input id="stationId" type="hidden" value="IALFAR32"/>
      </div>

      <div class="kpigrid">
        <div class="kpi"><b>Obs. totales</b><span id="kpiCount">—</span></div>
        <div class="kpi"><b>Temp. mín</b><span id="kpiMin">—</span></div>
        <div class="kpi"><b>Temp. máx</b><span id="kpiMax">—</span></div>
      </div>

      <div class="table-shell">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Fecha y hora</th>
              <th>Temp (°C)</th>
              <th>Precip (mm)</th>
              <th>Viento (km/h)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn);} }
  ready(function(){
  function toYYYYMMDD(d){ return d ? d.replace(/-/g,'') : ''; }
  function isNum(n){ return n!==null && n!==undefined && n!=='' && !isNaN(Number(n)); }
  function pick(){ for(var i=0;i<arguments.length;i++){ var v=arguments[i]; if(isNum(v)) return Number(v); } return null; }
  function fmt(n, digits){ if(!isNum(n)) return '—'; return Number(n).toFixed(digits||1); }
  function hhmm(iso){ return (iso && iso.length>=16) ? iso.slice(11,16) : ''; }

  // Intenta ser compatible con varias formas de respuesta del backend
  function parseWUResponse(json){
    var arr=[];
    if (json && json.observations && Array.isArray(json.observations)) arr=json.observations;
    else if (Array.isArray(json)) arr=json;
    else if (json && json.data && Array.isArray(json.data)) arr=json.data;
    return arr.map(function(o){
      var m = o && o.metric ? o.metric : (o || {});
      // hora local o utc
      var tLocal = (o && (o.obsTimeLocal || o.obsTimeUtc || o.valid_time_local || o.validTimeLocal)) || (o && o.epoch ? new Date(o.epoch*1000).toISOString() : '');

      // Temperatura en °C (prioriza valor instantáneo, luego media, luego máx/mín)
      var temp = pick(m.temp, m.temperature, m.tempAvg, m.tempAverage, m.tempHigh, m.tempLow, o.temp, o.temperature);

      // Precipitación en mm (prioriza acumulado del intervalo, luego tasa, luego genérico)
      var precip = pick(m.precipTotal, m.precip, m.precipRate, o.precipTotal, o.precip, o.precipRate);

      // Viento en km/h (prioriza instantáneo/medio, luego rachas si no hay otra cosa)
      var wind = pick(m.windSpeed, m.windspeed, m.windSpeedAvg, m.windAvg, o.windSpeed, o.windspeed, m.windgust, m.windGust, m.windgustHigh);

      return { timeLocal: tLocal, temp: temp, precip: precip, wind: wind };
    });
  }

  async function loadData(){
    var status=document.getElementById('status');
    var stationEl=document.getElementById('station')||document.getElementById('stationId');
    var dateEl=document.getElementById('date'); var endEl=null; // solo un selector de fecha
    if(!stationEl||!dateEl){ alert('Falta #station/#stationId o #date'); return; }
    var stationId=(stationEl.value||'').trim(); var startISO=(dateEl.value||'').trim();
    var endISO=startISO;
    if(!stationId||!startISO){ if(status) status.textContent='Completa estación y fecha.'; return; }

    var tbody=document.querySelector('#dataTable tbody'); tbody.innerHTML='';
    var minT=Infinity,maxT=-Infinity,totalRows=0,dayCount=0;

    var toDate=s=>new Date(s+'T00:00:00'); var fmtDate=d=>d.toISOString().slice(0,10); var addDays=(d,n)=>{var x=new Date(d); x.setDate(x.getDate()+n); return x;};

    for(var d=toDate(startISO); d<=toDate(endISO); d=addDays(d,1)){
      var dayISO=fmtDate(d); if(status) status.textContent='Cargando '+dayISO+'…';
      var url=location.origin+'/api/wu/history?stationId='+encodeURIComponent(stationId)+'&date='+encodeURIComponent(toYYYYMMDD(dayISO));
      try{
        var res=await fetch(url);
        var text=await res.text();
        var json; try{ json=JSON.parse(text); }catch(e){ json={error:text}; }
        if(!res.ok || json.error){
          var trErr=document.createElement('tr'); trErr.innerHTML='<td colspan=4>Error '+(json.error||res.status)+'</td>'; tbody.appendChild(trErr); continue;
        }
        var rows=parseWUResponse(json);
        rows.forEach(function(r){
          if(isNum(r.temp)){ minT=Math.min(minT, Number(r.temp)); maxT=Math.max(maxT, Number(r.temp)); }
          var hora=(r.timeLocal&&r.timeLocal.length>=16)?(dayISO+' '+r.timeLocal.slice(11,16)):dayISO;
          var tr=document.createElement('tr');
          tr.innerHTML='<td>'+hora+'</td><td>'+fmt(r.temp,1)+'</td><td>'+fmt(r.precip,1)+'</td><td>'+fmt(r.wind,1)+'</td>';
          tbody.appendChild(tr);
        });
        totalRows+=rows.length; dayCount++;
      }catch(e){
        var trCatch=document.createElement('tr'); trCatch.innerHTML='<td colspan=4>No se pudo cargar '+dayISO+'</td>'; tbody.appendChild(trCatch);
      }
    }
    if(document.getElementById('kpiCount')) document.getElementById('kpiCount').textContent=String(totalRows);
    if(document.getElementById('kpiMin')) document.getElementById('kpiMin').textContent=(isFinite(minT)?minT.toFixed(1)+' °C':'—');
    if(document.getElementById('kpiMax')) document.getElementById('kpiMax').textContent=(isFinite(maxT)?maxT.toFixed(1)+' °C':'—');
    if(status) status.textContent='Listo. Días cargados: '+dayCount+'.';
  }

  // CSV/XLS respetan el orden de columnas visible
  function toCSV(){
    var head=[].map.call(document.querySelectorAll('#dataTable thead th'), th=>(th.textContent||'').trim());
    var lines=[head.join(',')];
    var trs=document.querySelectorAll('#dataTable tbody tr');
    for(var i=0;i<trs.length;i++){
      var tds=trs[i].querySelectorAll('td');
      var row=[]; for(var c=0;c<tds.length;c++){ row.push((tds[c].textContent||'').trim()); }
      lines.push(row.join(','));
    }
    var blob=new Blob([lines.join('
')],{type:'text/csv;charset=utf-8;'});
    var a=document.createElement('a'); var today=new Date().toISOString().slice(0,10);
    a.href=URL.createObjectURL(blob); a.download='historico_'+today+'.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  function toXLSX(){
    var table=document.getElementById('dataTable'); var today=new Date().toISOString().slice(0,10);
    if(window.XLSX&&XLSX.utils&&XLSX.writeFile){
      try{ var wb=XLSX.utils.table_to_book(table, {sheet:"Datos"}); XLSX.writeFile(wb, 'historico_'+today+'.xlsx'); return; }catch(e){ console.error(e); }
    }
    var html='<html><head><meta charset="utf-8"></head><body>'+table.outerHTML+'</body></html>';
    var blob=new Blob([html],{type:'application/vnd.ms-excel'});
    var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='historico_'+today+'.xls'; a.click(); URL.revokeObjectURL(a.href);
  }

  // Exponer handlers
  window.__alfarnate={loadData, toCSV, toXLSX};
  var _l=document.getElementById('loadBtn'); if(_l) _l.addEventListener('click', loadData);
  var _c=document.getElementById('csvBtn'); if(_c) _c.addEventListener('click', toCSV);
  var _x=document.getElementById('xlsxBtn'); if(_x) _x.addEventListener('click', toXLSX);
  });
})();

</script>
</body>
</html>
